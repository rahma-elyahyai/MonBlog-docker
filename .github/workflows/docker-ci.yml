name: MonBlog CI/CD (Docker)

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  docker-test:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: ğŸ§± Build Docker images
        run: docker compose build

      - name: ğŸš€ Start containers
        run: docker compose up -d

      - name: â³ Wait for MySQL
        run: |
          for i in {1..30}; do
            if docker exec monblog-db mysqladmin ping -uroot -proot --silent; then
              echo "MySQL is ready"
              break
            fi
            sleep 2
          done

      - name: ğŸ§ª Test database
        run: docker exec monblog-db mysql -uroot -proot -e "SHOW DATABASES;"

      - name: ğŸŒ Test web (Apache)
        run: docker exec monblog-web curl -f http://localhost/src/index.php


      - name: ğŸ§¹ Stop containers
        run: docker compose down -v
